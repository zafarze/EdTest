from django.core.cache import cache
import logging

# –ü–æ–ø—ã—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–∏. –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –µ—â–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, –∫–æ–¥ –Ω–µ —É–ø–∞–¥–µ—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.
try:
    from ..models import AIPrompt
except ImportError:
    AIPrompt = None

logger = logging.getLogger(__name__)

class PromptService:
    """
    üß† Brain Center: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞–º–∏.
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ö—ç—à -> –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö -> Hardcoded Defaults.
    """

    # –•–∞—Ä–¥–∫–æ–¥-—Ä–µ–∑–µ—Ä–≤ (Factory Settings)
    DEFAULTS = {
        # 1. –ê–£–î–ò–¢ –í–û–ü–†–û–°–ê (–°–∞–º—ã–π –≤–∞–∂–Ω—ã–π –ø—Ä–æ–º–ø—Ç)
        "question_audit": {
            "system": """–¢—ã ‚Äî –°—Ç—Ä–æ–≥–∏–π –ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –†–µ–≤–∏–∑–æ—Ä. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ –õ–Æ–ë–£–Æ –æ—à–∏–±–∫—É: —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é, –ª–æ–≥–∏—á–µ—Å–∫—É—é –∏–ª–∏ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫—É—é.
            
            –ü–†–ê–í–ò–õ–ê:
            1. –§–∞–∫—Ç—ã: –ü—Ä–æ–≤–µ—Ä—è–π –¥–∞—Ç—ã, —Ñ–æ—Ä–º—É–ª—ã, —Å—Ç–æ–ª–∏—Ü—ã. –ï—Å–ª–∏ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–µ–Ω ‚Äî —ç—Ç–æ –æ—à–∏–±–∫–∞.
            2. –õ–æ–≥–∏–∫–∞: –ï—Å—Ç—å –ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç? –ù–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã?
            3. –Ø–∑—ã–∫: –ü—Ä–æ–≤–µ—Ä—è–π –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é (–†—É—Å—Å–∫–∏–π/–¢–∞–¥–∂–∏–∫—Å–∫–∏–π/–ê–Ω–≥–ª–∏–π—Å–∫–∏–π).
            
            –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON):
            {
                "valid": boolean,
                "message": "–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –∏–ª–∏ '–û–ö'",
                "suggestion": "–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞)"
            }
            """,
            "user": "–ü—Ä–æ–≤–µ—Ä—å —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å.\n–¢–µ–∫—Å—Ç: {text}\n–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:\n{choices}",
            "model": "gpt-4o",
            "temp": 0.2
        },

        # 2. –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–ò–°–¢–†–ê–ö–¢–û–†–û–í (–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤)
        "distractor_gen": {
            "system": """–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ —Å–æ—Å—Ç–∞–≤–∏—Ç–µ–ª—è —Ç–µ—Å—Ç–æ–≤. 
            –¢–≤–æ—è —Ü–µ–ª—å: –ø—Ä–∏–¥—É–º–∞—Ç—å 3 –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω—ã—Ö, –Ω–æ –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–• –æ—Ç–≤–µ—Ç–∞ (–¥–∏—Å—Ç—Ä–∞–∫—Ç–æ—Ä–∞).
            –û–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ç–æ–º –∂–µ —Å—Ç–∏–ª–µ –∏ –¥–ª–∏–Ω–µ, —á—Ç–æ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.
            –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON: { "distractors": ["–ê", "–ë", "–í"] }""",
            "user": "–í–æ–ø—Ä–æ—Å: {text}\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {answer}",
            "model": "gpt-4o",
            "temp": 0.7
        },

        # 3. –ü–ê–†–°–ï–† –§–ê–ô–õ–û–í (PDF/Word -> JSON)
        "file_parser": {
            "system": """–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ü–∏—Ñ—Ä–æ–≤—â–∏–∫ —ç–∫–∑–∞–º–µ–Ω–æ–≤. 
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ù–∞–π—Ç–∏ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã, –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å) –≤ —Ç–µ–∫—Å—Ç–µ.
            –ò–≥–Ω–æ—Ä–∏—Ä—É–π –∫–æ–ª–æ–Ω—Ç–∏—Ç—É–ª—ã –∏ –º—É—Å–æ—Ä.
            
            –í–µ—Ä–Ω–∏ –°–¢–†–û–ì–û JSON: 
            { 
              "questions": [
                {
                  "text": "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞",
                  "choices": [
                     {"text": "–í–∞—Ä–∏–∞–Ω—Ç –ê", "is_correct": false},
                     {"text": "–í–∞—Ä–∏–∞–Ω—Ç –ë", "is_correct": true}
                  ]
                }
              ] 
            }""",
            "user": "–ò–∑–≤–ª–µ–∫–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. {text}", # {text} –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
            "model": "gpt-4o",
            "temp": 0.1
        },

        # 4. –û–¢–ß–ï–¢ –ü–û –ö–õ–ê–°–°–£ (–ê–Ω–∞–ª–∏—Ç–∏–∫–∞)
        "class_report": {
            "system": "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –º–µ—Ç–æ–¥–∏—Å—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫. –¢—ã –ø–∏—à–µ—à—å –∫—Ä–∞—Ç–∫–∏–µ, –ø–æ–ª–µ–∑–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —É—á–∏—Ç–µ–ª—è–º.",
            "user": """–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫–∑–∞–º–µ–Ω–∞.
            –¢–µ–º–∞: {topic}
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–µ–Ω–∏–∫–æ–≤: {count}
            –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: {avg}%
            
            –ù–∞–ø–∏—à–∏ –æ—Ç—á–µ—Ç (3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):
            1. –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
            2. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è —É—á–∏—Ç–µ–ª—é (—á—Ç–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å, –∫–æ–≥–æ –ø–æ—Ö–≤–∞–ª–∏—Ç—å).
            –°—Ç–∏–ª—å: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π.""",
            "model": "gpt-4o",
            "temp": 0.7
        }
    }

    @staticmethod
    def get_prompt_config(slug: str):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–æ–º–ø—Ç–∞ (System, User Template, Model settings).
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 5 –º–∏–Ω—É—Ç.
        """
        cache_key = f"ai_prompt_config_{slug}"
        cached = cache.get(cache_key)
        
        if cached:
            return cached

        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≤ –ë–î (–µ—Å–ª–∏ –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞)
        if AIPrompt:
            try:
                prompt = AIPrompt.objects.get(slug=slug, is_active=True)
                config = {
                    "system": prompt.system_role,
                    "user": prompt.user_template,
                    "model": prompt.model_name,
                    "temp": prompt.temperature
                }
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                cache.set(cache_key, config, timeout=300) # 5 –º–∏–Ω—É—Ç
                return config
            except AIPrompt.DoesNotExist:
                pass # –ò–¥–µ–º –∫ –¥–µ—Ñ–æ–ª—Ç–∞–º
            except Exception as e:
                logger.warning(f"DB Error loading prompt '{slug}': {e}")

        # –ï—Å–ª–∏ –Ω–µ—Ç –≤ –ë–î –∏–ª–∏ –æ—à–∏–±–∫–∞ -> –±–µ—Ä–µ–º –¥–µ—Ñ–æ–ª—Ç (Fail-safe)
        default = PromptService.DEFAULTS.get(slug)
        if default:
            return default
            
        # –ï—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–∏—á–µ–≥–æ –Ω–µ—Ç (–∞–≤–∞—Ä–∏–π–Ω—ã–π —Å–ª—É—á–∞–π)
        return {
            "system": "You are a helpful assistant.",
            "user": "{text}",
            "model": "gpt-3.5-turbo",
            "temp": 0.5
        }

    @staticmethod
    def format_messages(slug: str, context: dict):
        """
        –°–æ–±–∏—Ä–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π payload –¥–ª—è OpenAI API.
        context: —Å–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä {'text': '...', 'choices': '...'}
        """
        config = PromptService.get_prompt_config(slug)
        
        system_msg = config['system']
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        # –ï—Å–ª–∏ –≤ –±–∞–∑–µ –∫—Ç–æ-—Ç–æ –Ω–∞–ø–∏—Å–∞–ª –ø—Ä–æ–º–ø—Ç "–ü—Ä–∏–≤–µ—Ç {name}", –∞ –º—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏ name,
        # –∫–æ–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω —É–ø–∞—Å—Ç—å.
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º .format, –Ω–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ
            user_msg = config['user'].format(**context)
        except KeyError as e:
            logger.error(f"Prompt formatting error for '{slug}': Missing key {e}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —à–∞–±–ª–æ–Ω –∫–∞–∫ –µ—Å—Ç—å, –¥–æ–±–∞–≤–∏–≤ –∏–Ω—Ñ–æ –æ–± –æ—à–∏–±–∫–µ (—á—Ç–æ–±—ã –¥–µ–±–∞–∂–∏—Ç—å)
            # –ò–ª–∏ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–º–µ–Ω–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–ª—é—á–∏ –Ω–∞ –∑–∞–≥–ª—É—à–∫–∏
            missing_key = str(e).strip("'")
            context[missing_key] = f"[MISSING: {missing_key}]"
            try:
                user_msg = config['user'].format(**context)
            except:
                user_msg = config['user'] # –°–æ–≤—Å–µ–º —Å–¥–∞–µ–º—Å—è, –æ—Ç–¥–∞–µ–º —Å—ã—Ä–æ–π —à–∞–±–ª–æ–Ω

        return [
            {"role": "system", "content": system_msg},
            {"role": "user", "content": user_msg}
        ], config