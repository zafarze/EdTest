import openai
from django.conf import settings
from typing import Dict, List

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å OpenAI
openai.api_key = "–¢–í–û–ô_–ö–õ–Æ–ß_–ò–õ–ò_–ò–ó_SETTINGS"

class AIAdvisorService:
    """
    –≠–ª–∏—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç 'Expensive AI' –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—É—Ö–∏—Ö —Ü–∏—Ñ—Ä.
    """

    @staticmethod
    def generate_strategic_insight(
        risk_students: List[Dict], 
        weak_topics: List[Dict], 
        trend: float
    ) -> Dict:
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ò–ò –∏ –ø–æ–ª—É—á–∞–µ—Ç JSON —Å —Å–æ–≤–µ—Ç–∞–º–∏.
        """
        
        # 1. –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ü—Ä–æ–º–ø—Ç)
        prompt = f"""
        –¢—ã ‚Äî —ç–ª–∏—Ç–Ω—ã–π –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∏ —Å—Ç—Ä–∞—Ç–µ–≥.
        –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ —à–∫–æ–ª—ã –∑–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é:
        
        1. üìâ –û–±—â–∏–π —Ç—Ä–µ–Ω–¥ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏: {trend:+.1f}%
        
        2. üÜò –£—á–µ–Ω–∏–∫–∏ –≤ –∑–æ–Ω–µ —Ä–∏—Å–∫–∞ (–¢–æ–ø-3):
        {", ".join([f"{s['name']} (—É–ø–∞–ª –Ω–∞ {s['drop']}%)" for s in risk_students])}
        
        3. üß† –ü—Ä–æ–≤–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã:
        {", ".join([t['name'] for t in weak_topics])}
        
        –¢–í–û–Ø –ó–ê–î–ê–ß–ê:
        –í–µ—Ä–Ω–∏ JSON —Å –ø–æ–ª—è–º–∏:
        - "title": –ö–æ—Ä–æ—Ç–∫–∏–π, —Ç—Ä–µ–≤–æ–∂–Ω—ã–π –∏–ª–∏ –æ–±–æ–¥—Ä—è—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫.
        - "insight": –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω—ã (–ø–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?).
        - "action": –û–¥–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞.
        - "severity": –£—Ä–æ–≤–µ–Ω—å —Ç—Ä–µ–≤–æ–≥–∏ ("low", "medium", "critical").
        
        –ù–µ –ø–∏—à–∏ –±–∞–Ω–∞–ª—å–Ω–æ—Å—Ç–∏. –ü–∏—à–∏ –∫–∞–∫ –ø—Ä–æ—Ñ–∏.
        """

        # 2. –ó–∞–ø—Ä–æ—Å –∫ –ò–ò (–°–∏–º—É–ª—è—Ü–∏—è –≤—ã–∑–æ–≤–∞ GPT-4)
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –≤—ã–∑–æ–≤ client.chat.completions.create
        try:
            # response = openai.chat.completions.create(
            #     model="gpt-4-turbo",
            #     messages=[{"role": "user", "content": prompt}],
            #     response_format={"type": "json_object"}
            # )
            # return json.loads(response.choices[0].message.content)
            
            # --- –ó–ê–ì–õ–£–®–ö–ê (–ü–æ–∫–∞ —Ç—ã –Ω–µ –≤—Å—Ç–∞–≤–∏–ª –∫–ª—é—á) ---
            # –ò–º–∏—Ç–∏—Ä—É–µ–º, —á—Ç–æ –ò–ò –ø–æ–¥—É–º–∞–ª –∏ –æ—Ç–≤–µ—Ç–∏–ª
            return {
                "title": "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø–∞–¥–µ–Ω–∏–µ –ø–æ –ì–µ–æ–º–µ—Ç—Ä–∏–∏",
                "insight": f"–ó–∞–º–µ—á–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞. –£—á–µ–Ω–∏–∫–∏ 10-—Ö –∫–ª–∞—Å—Å–æ–≤ –º–∞—Å—Å–æ–≤–æ '–ø–æ–ø–ª—ã–ª–∏' –Ω–∞ —Ç–µ–º–µ –°—Ç–µ—Ä–µ–æ–º–µ—Ç—Ä–∏—è. –≠—Ç–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç —Å –ø—Ä–æ—Å–∞–¥–∫–æ–π —É {risk_students[0]['name'] if risk_students else '–ª–∏–¥–µ—Ä–æ–≤'}.",
                "action": "–ü—Ä–æ–≤–µ—Å—Ç–∏ '–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –•–∞–∫–∞—Ç–æ–Ω' –≤–º–µ—Å—Ç–æ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π, —á—Ç–æ–±—ã —Å–Ω—è—Ç—å —Å—Ç—Ä–∞—Ö –ø–µ—Ä–µ–¥ —Ç–µ–º–æ–π.",
                "severity": "critical" if trend < 0 else "medium"
            }
        except Exception as e:
            return {
                "title": "–û—à–∏–±–∫–∞ AI –ê–Ω–∞–ª–∏–∑–∞",
                "insight": "–ù–µ–π—Ä–æ—Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.",
                "action": "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∏—Å—Ç–µ–º—É.",
                "severity": "low"
            }